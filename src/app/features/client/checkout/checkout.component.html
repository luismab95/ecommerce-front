<div class="min-h-screen bg-background py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-3xl font-bold text-text-main mb-8">Finalizar Pedido</h1>

        @if (cartService.cartItems().length === 0) {
        <!-- Empty Cart State -->
        <div class="bg-surface rounded-lg shadow-md p-12 text-center">
            <svg class="w-24 h-24 mx-auto text-text-muted mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
            <h2 class="text-2xl font-semibold text-text-main mb-2">No hay items para procesar</h2>
            <p class="text-text-muted mb-6">Agrega productos a tu carrito antes de continuar</p>
            <a routerLink="/products"
                class="inline-block px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:shadow-lg hover:scale-105 transition-all duration-200 font-medium">
                Explorar Productos
            </a>
        </div>
        } @else {
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Forms -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Billing Address -->
                <div class="bg-surface rounded-lg shadow-md p-6 border border-border">
                    <h2 class="text-xl font-bold text-text-main mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                        </svg>
                        Dirección de Facturación
                    </h2>

                    <form [formGroup]="billingAddressForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-main mb-1">Calle</label>
                            <input type="text" formControlName="street"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="123 Main St" />
                            @if (billingAddressForm.get('street')?.invalid &&
                            billingAddressForm.get('street')?.touched) {
                            <p class="text-red-500 text-sm mt-1">La calle es requerida (mínimo 5 caracteres)</p>
                            }
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Ciudad</label>
                                <input type="text" formControlName="city"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="New York" />
                                @if (billingAddressForm.get('city')?.invalid &&
                                billingAddressForm.get('city')?.touched) {
                                <p class="text-red-500 text-sm mt-1">La ciudad es requerida</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Estado/Provincia</label>
                                <input type="text" formControlName="state"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="NY" />
                                @if (billingAddressForm.get('state')?.invalid &&
                                billingAddressForm.get('state')?.touched) {
                                <p class="text-red-500 text-sm mt-1">Estado requerido (2 letras)</p>
                                }
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Código Postal</label>
                                <input type="text" formControlName="code"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="10001" maxlength="5" />
                                @if (billingAddressForm.get('code')?.invalid &&
                                billingAddressForm.get('code')?.touched) {
                                <p class="text-red-500 text-sm mt-1">Código postal inválido (5 dígitos)</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">País</label>
                                <input type="text" formControlName="country"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="USA" />
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Shipping Address -->
                <div class="bg-surface rounded-lg shadow-md p-6 border border-border">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-text-main flex items-center gap-2">
                            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                            </svg>
                            Dirección de Envío
                        </h2>

                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" [checked]="sameAsBilling()" (change)="toggleSameAsBilling()"
                                [disabled]="isProcessing()"
                                class="w-4 h-4 text-primary border-border rounded focus:ring-primary disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed" />
                            <span class="text-sm text-text-main">Igual que facturación</span>
                        </label>
                    </div>

                    <form [formGroup]="shippingAddressForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-main mb-2">Correo Electrónico</label>
                            <input type="email" formControlName="email"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="tu@email.com" />
                            @if (shippingAddressForm.get('email')?.invalid && shippingAddressForm.get('email')?.touched)
                            {
                            <p class="text-red-500 text-sm mt-1">Ingresa un correo electrónico válido</p>
                            }
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-main mb-2">Teléfono</label>
                            <input type="tel" formControlName="phone"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="+34612345678" />
                            @if (shippingAddressForm.get('phone')?.invalid && shippingAddressForm.get('phone')?.touched)
                            {
                            <p class="text-red-500 text-sm mt-1">Ingresa un número de teléfono válido (formato:
                                +34612345678)</p>
                            }
                        </div>


                        @if(!sameAsBilling()) {
                        <div>
                            <label class="block text-sm font-medium text-text-main mb-1">Calle</label>
                            <input type="text" formControlName="street"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="123 Main St" />
                            @if (shippingAddressForm.get('street')?.invalid &&
                            shippingAddressForm.get('street')?.touched) {
                            <p class="text-red-500 text-sm mt-1">La calle es requerida (mínimo 5 caracteres)</p>
                            }
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Ciudad</label>
                                <input type="text" formControlName="city"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="New York" />
                                @if (shippingAddressForm.get('city')?.invalid &&
                                shippingAddressForm.get('city')?.touched) {
                                <p class="text-red-500 text-sm mt-1">La ciudad es requerida</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Estado</label>
                                <input type="text" formControlName="state"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="NY" />
                                @if (shippingAddressForm.get('state')?.invalid &&
                                shippingAddressForm.get('state')?.touched) {
                                <p class="text-red-500 text-sm mt-1">Estado requerido (2 letras)</p>
                                }
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Código Postal</label>
                                <input type="text" formControlName="code"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="10001" maxlength="5" />
                                @if (shippingAddressForm.get('code')?.invalid &&
                                shippingAddressForm.get('code')?.touched) {
                                <p class="text-red-500 text-sm mt-1">Código postal inválido (5 dígitos)</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">País</label>
                                <input type="text" formControlName="country"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="USA" />
                            </div>
                        </div>
                        }
                    </form>
                </div>

                <!-- Payment Method -->
                <div class="bg-surface rounded-lg shadow-md p-6 border border-border">
                    <h2 class="text-xl font-bold text-text-main mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                        </svg>
                        Método de Pago
                    </h2>

                    <div class="space-y-3 mb-6">
                        @for (method of paymentMethods; track method) {
                        <label
                            class="flex items-center gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all hover:border-primary"
                            [class.border-primary]="selectedPaymentMethod() === method"
                            [class.bg-primary/5]="selectedPaymentMethod() === method"
                            [class.border-border]="selectedPaymentMethod() !== method">
                            <input type="radio" [value]="method" [checked]="selectedPaymentMethod() === method"
                                [disabled]="isProcessing()" (change)="selectPaymentMethod(method)"
                                class="w-4 h-4 text-primary disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed" />
                            <div class="flex-1">
                                <span class="font-medium text-text-main">{{ method }}</span>
                            </div>
                            @if (method === 'Credit Card' || method === 'Debit Card') {
                            <svg class="w-8 h-8 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                            </svg>
                            }
                        </label>
                        }
                    </div>

                    <!-- Card Details (shown only for card payments) -->
                    @if (selectedPaymentMethod() === 'Credit Card' || selectedPaymentMethod() === 'Debit Card') {
                    <form [formGroup]="paymentForm" class="space-y-4 pt-4 border-t border-border">
                        <div>
                            <label class="block text-sm font-medium text-text-main mb-1">Nombre del Titular</label>
                            <input type="text" formControlName="cardHolderName"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="John Doe" />
                            @if (paymentForm.get('cardHolderName')?.invalid &&
                            paymentForm.get('cardHolderName')?.touched) {
                            <p class="text-red-500 text-sm mt-1">Nombre del titular requerido</p>
                            }
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-text-main mb-1">Número de Tarjeta</label>
                            <input type="text" formControlName="cardNumber"
                                class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                placeholder="1234 5678 9012 3456" maxlength="19" />
                            @if (paymentForm.get('cardNumber')?.invalid && paymentForm.get('cardNumber')?.touched) {
                            <p class="text-red-500 text-sm mt-1">Número de tarjeta inválido (13-19 dígitos)</p>
                            }
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">Fecha de Expiración</label>
                                <input type="text" formControlName="expiryDate"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="MM/YY" maxlength="5" />
                                @if (paymentForm.get('expiryDate')?.invalid &&
                                paymentForm.get('expiryDate')?.touched) {
                                <p class="text-red-500 text-sm mt-1">Formato: MM/YY</p>
                                }
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-text-main mb-1">CVV</label>
                                <input type="text" formControlName="cvv"
                                    class="w-full px-4 py-3 rounded-lg bg-surface-subtle border border-border text-text-main focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300 disabled:bg-gray-100 disabled:text-gray-500 disabled:border-gray-300 disabled:cursor-not-allowed"
                                    placeholder="123" maxlength="4" />
                                @if (paymentForm.get('cvv')?.invalid && paymentForm.get('cvv')?.touched) {
                                <p class="text-red-500 text-sm mt-1">CVV inválido (3-4 dígitos)</p>
                                }
                            </div>
                        </div>
                    </form>
                    }
                </div>

                <!-- Order Summary (Mobile) -->
                <div class="lg:hidden bg-surface rounded-lg shadow-md p-6 border border-border">
                    <h2 class="text-xl font-bold text-text-main mb-4">Resumen del Pedido</h2>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-text-main">
                            <span>Subtotal</span>
                            <span class="font-semibold">${{ subtotal().toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between text-text-main">
                            <span>Impuestos</span>
                            <span class="font-semibold">${{ tax().toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between text-text-main">
                            <span>Envío</span>
                            <span class="font-semibold" [class.text-green-600]="shippingCost() === 0">
                                {{ shippingCost() === 0 ? 'Gratis' : '$' + shippingCost().toFixed(2) }}
                            </span>
                        </div>
                        <div class="border-t border-border pt-3">
                            <div class="flex justify-between text-lg font-bold text-text-main">
                                <span>Total</span>
                                <span class="text-primary">${{ total().toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary & Actions -->
            <div class="lg:col-span-1">
                <div class="bg-surface rounded-lg shadow-md p-6 border border-border sticky top-24">
                    <h2 class="text-xl font-bold text-text-main mb-4">Resumen del Pedido</h2>

                    <!-- Cart Items -->
                    <div class="space-y-3 mb-6 max-h-64 overflow-y-auto">
                        @for (item of cartService.cartItems(); track item.product.id) {
                        <div class="flex gap-3 pb-3 border-b border-border last:border-0">
                            @if (item.product.images && item.product.images.length > 0) {
                            <img [src]="item.product.images[0].path" [alt]="item.product.name"
                                class="w-16 h-16 object-cover rounded-lg" />
                            } @else {
                            <div class="w-16 h-16 bg-surface-subtle rounded-lg flex items-center justify-center">
                                <svg class="w-8 h-8 text-text-muted" fill="none" stroke="currentColor"
                                    viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            }
                            <div class="flex-1 min-w-0">
                                <h3 class="font-medium text-text-main text-sm truncate">{{ item.product.name }}</h3>
                                <p class="text-text-muted text-xs">Cant: {{ item.quantity }}</p>
                                <p class="text-primary font-semibold text-sm">${{ (item.product.price *
                                    item.quantity).toFixed(2) }}</p>
                            </div>
                        </div>
                        }
                    </div>

                    <!-- Price Summary -->
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-text-main">
                            <span>Subtotal</span>
                            <span class="font-semibold">${{ subtotal().toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between text-text-main">
                            <span>Impuestos</span>
                            <span class="font-semibold">${{ tax().toFixed(2) }}</span>
                        </div>
                        <div class="flex justify-between text-text-main">
                            <span>Envío</span>
                            <span class="font-semibold" [class.text-green-600]="shippingCost() === 0">
                                {{ shippingCost() === 0 ? 'Gratis' : '$' + shippingCost().toFixed(2) }}
                            </span>
                        </div>
                        <div class="border-t border-border pt-3">
                            <div class="flex justify-between text-lg font-bold text-text-main">
                                <span>Total</span>
                                <span class="text-primary">${{ total().toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <button (click)="placeOrder()" [disabled]="isProcessing() || !isFormValid()"
                        class="w-full px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-lg hover:shadow-lg hover:scale-105 transition-all duration-200 font-medium mb-3 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                        @if (isProcessing()) {
                        <span class="flex items-center justify-center gap-2">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                            Procesando...
                        </span>
                        } @else {
                        <span>Realizar Pedido</span>
                        }
                    </button>

                    <a routerLink="/cart"
                        class="block w-full px-6 py-3 bg-surface border border-border text-text-main rounded-lg hover:bg-surface-subtle transition-colors text-center font-medium">
                        Volver al Carrito
                    </a>

                    <!-- Security Badge -->
                    <div class="mt-6 pt-6 border-t border-border">
                        <div class="flex items-center gap-2 text-text-muted text-sm">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            <span>Pago seguro y protegido</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        }
    </div>
</div>